# 富农商城实时通信

术语：

接入系统：接入本实时通信工具的系统。实时通信工具需要维护用户账号与接入系统用户账号的一对一关系，能够将接入系统的账号信息与自身同步（昵称，头像，手机号码等）

## 功能需求 （选中的是本系统需要的功能）
用户（id，昵称，头像，手机号，邮箱，到网站的链接） 
- [x] 注册
- [x] 更新信息（与接入系统同步）
- [x] 点击用户头像跳转到网站（app）页面

联系人  
- [x] 添加/批量添加/删除
- [x] 列表展示

聊天室  
- [x] 单聊
- [x] 群聊
- [x] 在线状态
- [x] 离线消息通知

消息类型  
- [x] 文本
- [x] 表情
- [x] 图片
- [x] 语音
- [x] 短视频

消息持久化  
- [x] 云端持久化
- [ ] 本地缓存

音视频  
- [ ] 语音聊天
- [ ] 视频聊天（可扩展为直播）

前端接口和事件
- [x] 定制UI接口
- [x] 查询未读消息数量接口
- [x] 新消息事件
- [x] 未读消息事件

扩展服务
- [ ] 客服系统

## 方案
### 客户端
1. 网页
2. 手机网页
3. app

使用组件式设计，组件可以定制样式，但不能定制组合方式

`例如联系人列表，列表中包含多个联系人，可以定制列表的样式和每个联系人的样式，但不能改变联系人列表->联系人这个结构`

#### Reactjs + react-native
网页端使用react（preact），app端使用react-native

预估网页端库在100k-300k之间，固定文件页面跳转时可缓存。app端增加数M大小

集成方式：
- 网页：页面嵌入整个聊天js文件（可以使用bower/webpack，或直接在html中连接），手动调用登录接口启动实时通信。聊天采用弹出层模拟窗口的方式
- 手机网页：同上，不同处在于弹出层将覆盖整个手机可见区域
- app：原生app嵌入react-native执行环境，需要打开聊天页面时转到react-native执行环境处理

### vuejs + [weex](https://weex.apache.org/cn/)
开发模式和集成方式同reactjs

### ~~js + java + ObjectiveC~~
各个平台开发原生UI。工作量较大，多平台难以维护。

### 服务器端
易集成，易维护

#### 集成云服务
多个候选商：  
阿里百川（完全免费，无音视频聊天。云端聊天记录只保存一个月）  
融云（ 1,000 万条／日免费，即如活跃用户平均日消息量100条，免费支持10万活跃用户。音视频聊天额外付费。历史消息最多保存6个月）
环信（音视频聊天额外付费，30万日活跃用户免费。）

集成方式：接入模块包装为无状态java程序库（maven或graddle安装，或直接下载jar文件）（个人习惯java8语法，如有版本需求请指明）

优势：
- 初期或全期免费
- 支持包括客服系统的所有需求
- 运维简单
- 只需完成集成方案的开发
- 特殊需求无法定制
- 合理设计集成方式可较容易切换提供商

劣势：
- 除阿里百川外，大数据量情况下价格较高
- 更换服务提供商需额外开发

#### 开源XMPP服务器
Openfire

独立部署的服务器

通过XMPP扩展协议完成除音/视频聊天的其它功能  
可通过XMPP扩展协议+SIP服务器实现音/视频聊天

客服功能需要完全独立开发

优势：
- 易于开发特殊需求
- 大数据量时价格较低

劣势：
- 开发复杂度很高
- 额外的维护和运维成本

#### 集成XMPP组件库
深度依赖于接入系统。不推荐

**综上分析，个人倾向于使用react/react-native和后段云进行开发。周期大约为一个月。如不考虑视频/音频聊天的需求，使用阿里百川作为服务商。如需要超过一个月的聊天记录，可以在服务器端集成时加入一个持久化功能**  
**注：该实时通信工具不考虑58同城/一亩田类似的直接拨打对方电话的功能。此类功能应当单独开发，与实时通信独立**  
**注：直播功能可以通过视频聊天室实现，但最好是一个独立的功能，与实时通信独立**
